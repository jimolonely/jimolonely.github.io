<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Grpc练习 | 孤独的寂寞</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="练习下Grpc使用。
proto和Service定义 src/main/proto/AgentModel.proto
模型定义2个实体，参数和返回值。
syntax = &#34;proto3&#34;; option java_package = &#34;com.jimo.grpc&#34;; message AgentInfo { string name = 1; sint32 index = 2; } message ReportResponse { bool ok = 1; string msg = 2; } src/main/proto/AgentService.proto
在服务这边就定义一个report方法。
syntax = &#34;proto3&#34;; option java_package = &#34;com.jimo.grpc&#34;; import &#34;AgentModel.proto&#34;; service Agent { rpc report(AgentInfo) returns (ReportResponse) {} } 编译 加入maven插件，同时编译proto文件和grpc。
<extensions> <extension> <groupId>kr.motd.maven</groupId> <artifactId>os-maven-plugin</artifactId> <version>1.6.2</version> </extension> </extensions> <plugins> <plugin> <groupId>org.xolstice.maven.plugins</groupId> <artifactId>protobuf-maven-plugin</artifactId> <version>0.6.1</version> <configuration> <protocArtifact>com."><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="Grpc练习"><meta property="og:description" content="练习下Grpc使用。
proto和Service定义 src/main/proto/AgentModel.proto
模型定义2个实体，参数和返回值。
syntax = &#34;proto3&#34;; option java_package = &#34;com.jimo.grpc&#34;; message AgentInfo { string name = 1; sint32 index = 2; } message ReportResponse { bool ok = 1; string msg = 2; } src/main/proto/AgentService.proto
在服务这边就定义一个report方法。
syntax = &#34;proto3&#34;; option java_package = &#34;com.jimo.grpc&#34;; import &#34;AgentModel.proto&#34;; service Agent { rpc report(AgentInfo) returns (ReportResponse) {} } 编译 加入maven插件，同时编译proto文件和grpc。
<extensions> <extension> <groupId>kr.motd.maven</groupId> <artifactId>os-maven-plugin</artifactId> <version>1.6.2</version> </extension> </extensions> <plugins> <plugin> <groupId>org.xolstice.maven.plugins</groupId> <artifactId>protobuf-maven-plugin</artifactId> <version>0.6.1</version> <configuration> <protocArtifact>com."><meta property="og:type" content="article"><meta property="og:url" content="https://jimolonely.github.io/tech/java/grpc-demo/"><meta property="article:section" content="tech"><meta property="article:published_time" content="2022-05-26T22:48:27+08:00"><meta property="article:modified_time" content="2022-05-26T22:48:27+08:00"><meta property="og:site_name" content="孤独的寂寞"><meta itemprop=name content="Grpc练习"><meta itemprop=description content="练习下Grpc使用。
proto和Service定义 src/main/proto/AgentModel.proto
模型定义2个实体，参数和返回值。
syntax = &#34;proto3&#34;; option java_package = &#34;com.jimo.grpc&#34;; message AgentInfo { string name = 1; sint32 index = 2; } message ReportResponse { bool ok = 1; string msg = 2; } src/main/proto/AgentService.proto
在服务这边就定义一个report方法。
syntax = &#34;proto3&#34;; option java_package = &#34;com.jimo.grpc&#34;; import &#34;AgentModel.proto&#34;; service Agent { rpc report(AgentInfo) returns (ReportResponse) {} } 编译 加入maven插件，同时编译proto文件和grpc。
<extensions> <extension> <groupId>kr.motd.maven</groupId> <artifactId>os-maven-plugin</artifactId> <version>1.6.2</version> </extension> </extensions> <plugins> <plugin> <groupId>org.xolstice.maven.plugins</groupId> <artifactId>protobuf-maven-plugin</artifactId> <version>0.6.1</version> <configuration> <protocArtifact>com."><meta itemprop=datePublished content="2022-05-26T22:48:27+08:00"><meta itemprop=dateModified content="2022-05-26T22:48:27+08:00"><meta itemprop=wordCount content="293"><meta itemprop=keywords content="grpc,protobuf,java,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Grpc练习"><meta name=twitter:description content="练习下Grpc使用。
proto和Service定义 src/main/proto/AgentModel.proto
模型定义2个实体，参数和返回值。
syntax = &#34;proto3&#34;; option java_package = &#34;com.jimo.grpc&#34;; message AgentInfo { string name = 1; sint32 index = 2; } message ReportResponse { bool ok = 1; string msg = 2; } src/main/proto/AgentService.proto
在服务这边就定义一个report方法。
syntax = &#34;proto3&#34;; option java_package = &#34;com.jimo.grpc&#34;; import &#34;AgentModel.proto&#34;; service Agent { rpc report(AgentInfo) returns (ReportResponse) {} } 编译 加入maven插件，同时编译proto文件和grpc。
<extensions> <extension> <groupId>kr.motd.maven</groupId> <artifactId>os-maven-plugin</artifactId> <version>1.6.2</version> </extension> </extensions> <plugins> <plugin> <groupId>org.xolstice.maven.plugins</groupId> <artifactId>protobuf-maven-plugin</artifactId> <version>0.6.1</version> <configuration> <protocArtifact>com."><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-111673440-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="ma0 avenir bg-transparent"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">孤独的寂寞</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/ksa/ title="能力先行 页">能力先行</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/life/ title="谈人生 页">谈人生</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/read/ title="读书笔记 页">读书笔记</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tech/ title="技术 页">技术</a></li></ul><div class=ananke-socials><a href=https://github.com/jimolonely target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw9 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">JAVA</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Grpc练习</h1><time class="f6 mv4 dib tracked" datetime=2022-05-26T22:48:27+08:00>2022-05-26</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>练习下Grpc使用。</p><h2 id=proto和service定义>proto和Service定义</h2><p><code>src/main/proto/AgentModel.proto</code></p><p>模型定义2个实体，参数和返回值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;
</span></span><span style=display:flex><span>option java_package <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.jimo.grpc&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>message AgentInfo <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  string name <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>  sint32 index <span style=color:#f92672>=</span> 2;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>message ReportResponse <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  bool ok <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>  string msg <span style=color:#f92672>=</span> 2;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>src/main/proto/AgentService.proto</code></p><p>在服务这边就定义一个report方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>option java_package <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.jimo.grpc&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>import <span style=color:#e6db74>&#34;AgentModel.proto&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>service Agent <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  rpc report<span style=color:#f92672>(</span>AgentInfo<span style=color:#f92672>)</span> returns <span style=color:#f92672>(</span>ReportResponse<span style=color:#f92672>)</span> <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=编译>编译</h2><p>加入maven插件，同时编译proto文件和grpc。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>        <span style=color:#f92672>&lt;extensions&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;extension&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;groupId&gt;</span>kr.motd.maven<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;artifactId&gt;</span>os-maven-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;version&gt;</span>1.6.2<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/extension&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/extensions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;plugins&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;groupId&gt;</span>org.xolstice.maven.plugins<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;artifactId&gt;</span>protobuf-maven-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;version&gt;</span>0.6.1<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;protocArtifact&gt;</span>com.google.protobuf:protoc:${protoc.version}:exe:${os.detected.classifier}
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;/protocArtifact&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;pluginId&gt;</span>grpc-java<span style=color:#f92672>&lt;/pluginId&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;pluginArtifact&gt;</span>io.grpc:protoc-gen-grpc-java:${grpc.version}:exe:${os.detected.classifier}
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;/pluginArtifact&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&lt;goal&gt;</span>compile<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&lt;goal&gt;</span>compile-custom<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/plugins&gt;</span>
</span></span></code></pre></div><p>假如要用离线的proto执行文件，可以换成本地路径：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>            <span style=color:#f92672>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;groupId&gt;</span>org.xolstice.maven.plugins<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;artifactId&gt;</span>protobuf-maven-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;version&gt;</span>0.6.1<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;protocExecutable&gt;</span>D:\software\protoc.exe<span style=color:#f92672>&lt;/protocExecutable&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;pluginId&gt;</span>grpc-java<span style=color:#f92672>&lt;/pluginId&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;pluginExecutable&gt;</span>D:\software\protoc-gen-grpc-java.exe<span style=color:#f92672>&lt;/pluginExecutable&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&lt;goal&gt;</span>compile<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&lt;goal&gt;</span>compile-custom<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/plugin&gt;</span>
</span></span></code></pre></div><p>在命令行运行 <code>mvn compile</code> 可编译出protobuf和grpc的类，结构如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>└─target
</span></span><span style=display:flex><span>    ├─generated-sources
</span></span><span style=display:flex><span>    │  ├─annotations
</span></span><span style=display:flex><span>    │  └─protobuf
</span></span><span style=display:flex><span>    │      ├─grpc-java
</span></span><span style=display:flex><span>    │      │  └─com
</span></span><span style=display:flex><span>    │      │      └─jimo
</span></span><span style=display:flex><span>    │      │          └─grpc
</span></span><span style=display:flex><span>    │      │                  AgentGrpc.java
</span></span><span style=display:flex><span>    │      │
</span></span><span style=display:flex><span>    │      └─java
</span></span><span style=display:flex><span>    │          └─com
</span></span><span style=display:flex><span>    │              └─jimo
</span></span><span style=display:flex><span>    │                  └─grpc
</span></span><span style=display:flex><span>    │                          AgentModel.java
</span></span><span style=display:flex><span>    │                          AgentService.java
</span></span></code></pre></div><h2 id=服务端实现>服务端实现</h2><p>先实现服务的处理逻辑： <code>AgentServiceImpl</code> 继承 GRPC生成的抽象类。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.jimo.grpc.AgentGrpc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.jimo.grpc.AgentModel<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.grpc.stub.StreamObserver<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AgentServiceImpl</span> <span style=color:#66d9ef>extends</span> AgentGrpc<span style=color:#f92672>.</span><span style=color:#a6e22e>AgentImplBase</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>report</span><span style=color:#f92672>(</span>AgentModel<span style=color:#f92672>.</span><span style=color:#a6e22e>AgentInfo</span> request<span style=color:#f92672>,</span> StreamObserver<span style=color:#f92672>&lt;</span>AgentModel<span style=color:#f92672>.</span><span style=color:#a6e22e>ReportResponse</span><span style=color:#f92672>&gt;</span> responseObserver<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        AgentModel<span style=color:#f92672>.</span><span style=color:#a6e22e>ReportResponse</span> response <span style=color:#f92672>=</span> AgentModel<span style=color:#f92672>.</span><span style=color:#a6e22e>ReportResponse</span><span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setOk</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setMsg</span><span style=color:#f92672>(</span>request<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        responseObserver<span style=color:#f92672>.</span><span style=color:#a6e22e>onNext</span><span style=color:#f92672>(</span>response<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        responseObserver<span style=color:#f92672>.</span><span style=color:#a6e22e>onCompleted</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>然后起一个服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Server server <span style=color:#f92672>=</span> ServerBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>forPort</span><span style=color:#f92672>(</span>8000<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>addService</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> AgentServiceImpl<span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>().</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Runtime<span style=color:#f92672>.</span><span style=color:#a6e22e>getRuntime</span><span style=color:#f92672>().</span><span style=color:#a6e22e>addShutdownHook</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            server<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>().</span><span style=color:#a6e22e>awaitTermination</span><span style=color:#f92672>(</span>10<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}));</span>
</span></span><span style=display:flex><span>    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Listening on 8000...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    server<span style=color:#f92672>.</span><span style=color:#a6e22e>awaitTermination</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=客户端实现>客户端实现</h2><p>客户端一般共用一个 <code>Channel</code>,所以传进来.然后通过 <code>Stub</code>调用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.jimo.grpc.AgentGrpc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.jimo.grpc.AgentModel<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.grpc.Channel<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AgentClient</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> AgentGrpc<span style=color:#f92672>.</span><span style=color:#a6e22e>AgentBlockingStub</span> stub<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>AgentClient</span><span style=color:#f92672>(</span>Channel channel<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        stub <span style=color:#f92672>=</span> AgentGrpc<span style=color:#f92672>.</span><span style=color:#a6e22e>newBlockingStub</span><span style=color:#f92672>(</span>channel<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>report</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        AgentModel<span style=color:#f92672>.</span><span style=color:#a6e22e>ReportResponse</span> res <span style=color:#f92672>=</span> stub<span style=color:#f92672>.</span><span style=color:#a6e22e>report</span><span style=color:#f92672>(</span>AgentModel<span style=color:#f92672>.</span><span style=color:#a6e22e>AgentInfo</span><span style=color:#f92672>.</span><span style=color:#a6e22e>newBuilder</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;app01&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>setIndex</span><span style=color:#f92672>(</span>98<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;收到回复：&#34;</span> <span style=color:#f92672>+</span> res<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>客户端共用一个 <code>Channel</code>的创建和调用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// channel最好创建一个，可以共用，是线程安全的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ManagedChannel channel <span style=color:#f92672>=</span> ManagedChannelBuilder
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>forAddress</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>,</span> 8000<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 默认是SSL/TLS，这里不用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>usePlaintext</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    AgentClient agentClient <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AgentClient<span style=color:#f92672>(</span>channel<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    agentClient<span style=color:#f92672>.</span><span style=color:#a6e22e>report</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    agentClient<span style=color:#f92672>.</span><span style=color:#a6e22e>report</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// channel默认会等待一段时间关闭，如果不用了最好及时关闭，否则会占用TCP连接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    channel<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdownNow</span><span style=color:#f92672>().</span><span style=color:#a6e22e>awaitTermination</span><span style=color:#f92672>(</span>5<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=更多问题>更多问题</h2><p>1、我们需要对请求做拦截，做一些AOP的事情怎么弄？&mdash;-用 <code>ClientInterceptor</code></p><p>2、在上面的客户端使用了 <code>AgentGrpc.newBlockingStub(channel)</code>,还有好几种Stub，有什么区别，怎么使用？</p><p>3、客户端和服务端通信的网络和协议是如何实现的？为什么客户端的Channel会自动关闭？</p><ul class=pa0><li class="list di"><a href=/tags/grpc class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">grpc</a></li><li class="list di"><a href=/tags/protobuf class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">protobuf</a></li><li class="list di"><a href=/tags/java class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">java</a></li></ul><div class="mt6 instapaper_ignoref"><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//jimolonely.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">这个tech中有</p><nav id=TableOfContents><ul><li><a href=#proto和service定义>proto和Service定义</a></li><li><a href=#编译>编译</a></li><li><a href=#服务端实现>服务端实现</a></li><li><a href=#客户端实现>客户端实现</a></li><li><a href=#更多问题>更多问题</a></li></ul></nav></div><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">相关內容</p><ul class="pa0 list"><li class=mb2><a href=/tech/java/java-instanceof-list/>Java instanceof List&lt;T></a></li><li class=mb2><a href=/tech/java/java-agent/>Java Agent如何调试</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://jimolonely.github.io/>&copy; 孤独的寂寞 2022</a><div><div class=ananke-socials><a href=https://github.com/jimolonely target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>