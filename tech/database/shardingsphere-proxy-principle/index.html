<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>ShardingSphere proxy原理 | 孤独的寂寞</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="代理分为前端和后端。
类 MetaDataContextsBuilder会根据配置文件构建数据的上下文，其中包括 前端和后端数据库类型。
调用流程 FrontendChannelInboundHandler
@Override public void channelRead(final ChannelHandlerContext context, final Object message) { if (!authenticated) { authenticated = authenticate(context, (ByteBuf) message); return; } ProxyStateContext.execute(context, message, databaseProtocolFrontendEngine, connectionSession); } 然后采用JDBC代理 JDBCOKProxyState，这里使用了一个异步线程去处理。
@Override public void execute(final ChannelHandlerContext context, final Object message, final DatabaseProtocolFrontendEngine databaseProtocolFrontendEngine, final ConnectionSession connectionSession) { CommandExecutorTask commandExecutorTask = new CommandExecutorTask(databaseProtocolFrontendEngine, connectionSession, context, message); ExecutorService executorService = determineSuitableExecutorService(context, databaseProtocolFrontendEngine, connectionSession); executorService.execute(commandExecutorTask); } CommandExecutorTask
private boolean executeCommand(final ChannelHandlerContext context, final PacketPayload payload) throws SQLException { CommandExecuteEngine commandExecuteEngine = databaseProtocolFrontendEngine."><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="ShardingSphere proxy原理"><meta property="og:description" content="代理分为前端和后端。
类 MetaDataContextsBuilder会根据配置文件构建数据的上下文，其中包括 前端和后端数据库类型。
调用流程 FrontendChannelInboundHandler
@Override public void channelRead(final ChannelHandlerContext context, final Object message) { if (!authenticated) { authenticated = authenticate(context, (ByteBuf) message); return; } ProxyStateContext.execute(context, message, databaseProtocolFrontendEngine, connectionSession); } 然后采用JDBC代理 JDBCOKProxyState，这里使用了一个异步线程去处理。
@Override public void execute(final ChannelHandlerContext context, final Object message, final DatabaseProtocolFrontendEngine databaseProtocolFrontendEngine, final ConnectionSession connectionSession) { CommandExecutorTask commandExecutorTask = new CommandExecutorTask(databaseProtocolFrontendEngine, connectionSession, context, message); ExecutorService executorService = determineSuitableExecutorService(context, databaseProtocolFrontendEngine, connectionSession); executorService.execute(commandExecutorTask); } CommandExecutorTask
private boolean executeCommand(final ChannelHandlerContext context, final PacketPayload payload) throws SQLException { CommandExecuteEngine commandExecuteEngine = databaseProtocolFrontendEngine."><meta property="og:type" content="article"><meta property="og:url" content="https://jimolonely.github.io/tech/database/shardingsphere-proxy-principle/"><meta property="article:section" content="tech"><meta property="article:published_time" content="2022-05-21T16:42:13+08:00"><meta property="article:modified_time" content="2022-05-21T16:42:13+08:00"><meta property="og:site_name" content="孤独的寂寞"><meta itemprop=name content="ShardingSphere proxy原理"><meta itemprop=description content="代理分为前端和后端。
类 MetaDataContextsBuilder会根据配置文件构建数据的上下文，其中包括 前端和后端数据库类型。
调用流程 FrontendChannelInboundHandler
@Override public void channelRead(final ChannelHandlerContext context, final Object message) { if (!authenticated) { authenticated = authenticate(context, (ByteBuf) message); return; } ProxyStateContext.execute(context, message, databaseProtocolFrontendEngine, connectionSession); } 然后采用JDBC代理 JDBCOKProxyState，这里使用了一个异步线程去处理。
@Override public void execute(final ChannelHandlerContext context, final Object message, final DatabaseProtocolFrontendEngine databaseProtocolFrontendEngine, final ConnectionSession connectionSession) { CommandExecutorTask commandExecutorTask = new CommandExecutorTask(databaseProtocolFrontendEngine, connectionSession, context, message); ExecutorService executorService = determineSuitableExecutorService(context, databaseProtocolFrontendEngine, connectionSession); executorService.execute(commandExecutorTask); } CommandExecutorTask
private boolean executeCommand(final ChannelHandlerContext context, final PacketPayload payload) throws SQLException { CommandExecuteEngine commandExecuteEngine = databaseProtocolFrontendEngine."><meta itemprop=datePublished content="2022-05-21T16:42:13+08:00"><meta itemprop=dateModified content="2022-05-21T16:42:13+08:00"><meta itemprop=wordCount content="630"><meta itemprop=keywords content="shardingsphere,"><meta name=twitter:card content="summary"><meta name=twitter:title content="ShardingSphere proxy原理"><meta name=twitter:description content="代理分为前端和后端。
类 MetaDataContextsBuilder会根据配置文件构建数据的上下文，其中包括 前端和后端数据库类型。
调用流程 FrontendChannelInboundHandler
@Override public void channelRead(final ChannelHandlerContext context, final Object message) { if (!authenticated) { authenticated = authenticate(context, (ByteBuf) message); return; } ProxyStateContext.execute(context, message, databaseProtocolFrontendEngine, connectionSession); } 然后采用JDBC代理 JDBCOKProxyState，这里使用了一个异步线程去处理。
@Override public void execute(final ChannelHandlerContext context, final Object message, final DatabaseProtocolFrontendEngine databaseProtocolFrontendEngine, final ConnectionSession connectionSession) { CommandExecutorTask commandExecutorTask = new CommandExecutorTask(databaseProtocolFrontendEngine, connectionSession, context, message); ExecutorService executorService = determineSuitableExecutorService(context, databaseProtocolFrontendEngine, connectionSession); executorService.execute(commandExecutorTask); } CommandExecutorTask
private boolean executeCommand(final ChannelHandlerContext context, final PacketPayload payload) throws SQLException { CommandExecuteEngine commandExecuteEngine = databaseProtocolFrontendEngine."><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-111673440-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="ma0 avenir bg-transparent"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">孤独的寂寞</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/ksa/ title="能力先行 页">能力先行</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/life/ title="谈人生 页">谈人生</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/read/ title="读书笔记 页">读书笔记</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tech/ title="技术 页">技术</a></li></ul><div class=ananke-socials><a href=https://github.com/jimolonely target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw9 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">DATABASE</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">ShardingSphere proxy原理</h1><time class="f6 mv4 dib tracked" datetime=2022-05-21T16:42:13+08:00>2022-05-21</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>代理分为前端和后端。</p><p>类 <code>MetaDataContextsBuilder</code>会根据配置文件构建数据的上下文，其中包括 前端和后端数据库类型。</p><h2 id=调用流程>调用流程</h2><p>FrontendChannelInboundHandler</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>channelRead</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> ChannelHandlerContext context<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Object message<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>authenticated<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        authenticated <span style=color:#f92672>=</span> authenticate<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>ByteBuf<span style=color:#f92672>)</span> message<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    ProxyStateContext<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> message<span style=color:#f92672>,</span> databaseProtocolFrontendEngine<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>然后采用JDBC代理
JDBCOKProxyState，这里使用了一个异步线程去处理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> ChannelHandlerContext context<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Object message<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> DatabaseProtocolFrontendEngine databaseProtocolFrontendEngine<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> ConnectionSession connectionSession<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    CommandExecutorTask commandExecutorTask <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CommandExecutorTask<span style=color:#f92672>(</span>databaseProtocolFrontendEngine<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>,</span> context<span style=color:#f92672>,</span> message<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    ExecutorService executorService <span style=color:#f92672>=</span> determineSuitableExecutorService<span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> databaseProtocolFrontendEngine<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>commandExecutorTask<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>CommandExecutorTask</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>executeCommand</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> ChannelHandlerContext context<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> PacketPayload payload<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    CommandExecuteEngine commandExecuteEngine <span style=color:#f92672>=</span> databaseProtocolFrontendEngine<span style=color:#f92672>.</span><span style=color:#a6e22e>getCommandExecuteEngine</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    CommandPacketType type <span style=color:#f92672>=</span> commandExecuteEngine<span style=color:#f92672>.</span><span style=color:#a6e22e>getCommandPacketType</span><span style=color:#f92672>(</span>payload<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    CommandPacket commandPacket <span style=color:#f92672>=</span> commandExecuteEngine<span style=color:#f92672>.</span><span style=color:#a6e22e>getCommandPacket</span><span style=color:#f92672>(</span>payload<span style=color:#f92672>,</span> type<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    CommandExecutor commandExecutor <span style=color:#f92672>=</span> commandExecuteEngine<span style=color:#f92672>.</span><span style=color:#a6e22e>getCommandExecutor</span><span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> commandPacket<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Collection<span style=color:#f92672>&lt;</span>DatabasePacket<span style=color:#f92672>&lt;?&gt;&gt;</span> responsePackets <span style=color:#f92672>=</span> commandExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>responsePackets<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        responsePackets<span style=color:#f92672>.</span><span style=color:#a6e22e>forEach</span><span style=color:#f92672>(</span>context<span style=color:#f92672>::</span>write<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>commandExecutor <span style=color:#66d9ef>instanceof</span> QueryCommandExecutor<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            commandExecuteEngine<span style=color:#f92672>.</span><span style=color:#a6e22e>writeQueryData</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>.</span><span style=color:#a6e22e>getBackendConnection</span><span style=color:#f92672>(),</span> <span style=color:#f92672>(</span>QueryCommandExecutor<span style=color:#f92672>)</span> commandExecutor<span style=color:#f92672>,</span> responsePackets<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> SQLException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        databaseProtocolFrontendEngine<span style=color:#f92672>.</span><span style=color:#a6e22e>handleException</span><span style=color:#f92672>(</span>connectionSession<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> ex<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        commandExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>首先，前端数据库有以下几种实现：</p><p><img src=https://user-images.githubusercontent.com/17684996/169645143-057d5f1a-9e2f-424d-bd21-707b6e1695f2.png alt=image></p><p>执行引擎有几个数据库实现</p><p><img src=https://user-images.githubusercontent.com/17684996/169645220-14cc497e-6335-4a1c-9d51-49a62a761190.png alt=image></p><p>我们这里看MySQL的，根据其协议内容，有下面的一些命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> CommandExecutor <span style=color:#a6e22e>newInstance</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> MySQLCommandPacketType commandPacketType<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> CommandPacket commandPacket<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> ConnectionSession connectionSession<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    log<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Execute packet type: {}, value: {}&#34;</span><span style=color:#f92672>,</span> commandPacketType<span style=color:#f92672>,</span> commandPacket<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>commandPacketType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> COM_QUIT<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MySQLComQuitExecutor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> COM_INIT_DB<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MySQLComInitDbExecutor<span style=color:#f92672>((</span>MySQLComInitDbPacket<span style=color:#f92672>)</span> commandPacket<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> COM_FIELD_LIST<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MySQLComFieldListPacketExecutor<span style=color:#f92672>((</span>MySQLComFieldListPacket<span style=color:#f92672>)</span> commandPacket<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> COM_QUERY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MySQLComQueryPacketExecutor<span style=color:#f92672>((</span>MySQLComQueryPacket<span style=color:#f92672>)</span> commandPacket<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> COM_PING<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MySQLComPingExecutor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> COM_STMT_PREPARE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MySQLComStmtPrepareExecutor<span style=color:#f92672>((</span>MySQLComStmtPreparePacket<span style=color:#f92672>)</span> commandPacket<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> COM_STMT_EXECUTE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MySQLComStmtExecuteExecutor<span style=color:#f92672>((</span>MySQLComStmtExecutePacket<span style=color:#f92672>)</span> commandPacket<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> COM_STMT_RESET<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MySQLComStmtResetExecutor<span style=color:#f92672>((</span>MySQLComStmtResetPacket<span style=color:#f92672>)</span> commandPacket<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> COM_STMT_CLOSE<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MySQLComStmtCloseExecutor<span style=color:#f92672>((</span>MySQLComStmtClosePacket<span style=color:#f92672>)</span> commandPacket<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>.</span><span style=color:#a6e22e>getConnectionId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> COM_SET_OPTION<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MySQLComSetOptionExecutor<span style=color:#f92672>((</span>MySQLComSetOptionPacket<span style=color:#f92672>)</span> commandPacket<span style=color:#f92672>,</span> connectionSession<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MySQLUnsupportedCommandExecutor<span style=color:#f92672>(</span>commandPacketType<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在SS里，解析完协议后，每种命令都给了一种执行实现，我不确定用了哪种命令，就打断点看了一下：</p><p><img src=https://user-images.githubusercontent.com/17684996/169645957-7aae0036-668c-4dc6-b43f-89144ff69cc5.png alt=fa43bf8da6c0fcfb89ed99b56f89f4b></p><p><img src=https://user-images.githubusercontent.com/17684996/169645967-11d7f477-ff96-455d-a8c1-21a995658db4.png alt=03dfbd5aebdb7459a49e9aab57544d8></p><p><img src=https://user-images.githubusercontent.com/17684996/169645970-73c61bc9-ebf8-49f6-bc19-2c206956f7fb.png alt=956d4f17f5b7c59900697d083259122></p><p>发现都是 <code>MySQLComQueryPacketExecutor</code>, 在这个实现里，主要关注其 <code>execute</code>方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Collection<span style=color:#f92672>&lt;</span>DatabasePacket<span style=color:#f92672>&lt;?&gt;&gt;</span> execute<span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ResponseHeader responseHeader <span style=color:#f92672>=</span> textProtocolBackendHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>responseHeader <span style=color:#66d9ef>instanceof</span> QueryResponseHeader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> processQuery<span style=color:#f92672>((</span>QueryResponseHeader<span style=color:#f92672>)</span> responseHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    responseType <span style=color:#f92672>=</span> ResponseType<span style=color:#f92672>.</span><span style=color:#a6e22e>UPDATE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> responseHeader <span style=color:#66d9ef>instanceof</span> UpdateResponseHeader <span style=color:#f92672>?</span> processUpdate<span style=color:#f92672>((</span>UpdateResponseHeader<span style=color:#f92672>)</span> responseHeader<span style=color:#f92672>)</span> <span style=color:#f92672>:</span> processClientEncoding<span style=color:#f92672>((</span>ClientEncodingResponseHeader<span style=color:#f92672>)</span> responseHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在这里, <code>textProtocolBackendHandler.execute()</code>又有很多种实现，从上图可以看到是 <code>SchemaAssignedDatabaseBackendHandler</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> DatabaseCommunicationEngine<span style=color:#f92672>&lt;?&gt;</span> databaseCommunicationEngine<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> ResponseHeader <span style=color:#a6e22e>execute</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    prepareDatabaseCommunicationEngine<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>ResponseHeader<span style=color:#f92672>)</span> databaseCommunicationEngine<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里使用的 <code>databaseCommunicationEngine</code>实现是 <code>JDBCDatabaseCommunicationEngine</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> ResponseHeader <span style=color:#a6e22e>execute</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    LogicSQL logicSQL <span style=color:#f92672>=</span> getLogicSQL<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ExecutionContext executionContext <span style=color:#f92672>=</span> getKernelProcessor<span style=color:#f92672>().</span><span style=color:#a6e22e>generateExecutionContext</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            logicSQL<span style=color:#f92672>,</span> getDatabase<span style=color:#f92672>(),</span> ProxyContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getContextManager</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getMetaDataContexts</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getProps</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO move federation route logic to binder
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    SQLStatementContext<span style=color:#f92672>&lt;?&gt;</span> sqlStatementContext <span style=color:#f92672>=</span> logicSQL<span style=color:#f92672>.</span><span style=color:#a6e22e>getSqlStatementContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    String defaultDatabaseName <span style=color:#f92672>=</span> backendConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>getConnectionSession</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDatabaseName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>executionContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getRouteContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isFederated</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>sqlStatementContext <span style=color:#66d9ef>instanceof</span> SelectStatementContext
</span></span><span style=display:flex><span>            <span style=color:#f92672>&amp;&amp;</span> SystemSchemaUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>containsSystemSchema</span><span style=color:#f92672>(</span>sqlStatementContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getDatabaseType</span><span style=color:#f92672>(),</span> sqlStatementContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getTablesContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getSchemaNames</span><span style=color:#f92672>(),</span> defaultDatabaseName<span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        MetaDataContexts metaDataContexts <span style=color:#f92672>=</span> ProxyContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getContextManager</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getMetaDataContexts</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        ResultSet resultSet <span style=color:#f92672>=</span> doExecuteFederation<span style=color:#f92672>(</span>logicSQL<span style=color:#f92672>,</span> metaDataContexts<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> processExecuteFederation<span style=color:#f92672>(</span>resultSet<span style=color:#f92672>,</span> metaDataContexts<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>executionContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getExecutionUnits</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> UpdateResponseHeader<span style=color:#f92672>(</span>executionContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getSqlStatementContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getSqlStatement</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    proxySQLExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>checkExecutePrerequisites</span><span style=color:#f92672>(</span>executionContext<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    checkLockedDatabase<span style=color:#f92672>(</span>executionContext<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    List result <span style=color:#f92672>=</span> proxySQLExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>executionContext<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    refreshMetaData<span style=color:#f92672>(</span>executionContext<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Object executeResultSample <span style=color:#f92672>=</span> result<span style=color:#f92672>.</span><span style=color:#a6e22e>iterator</span><span style=color:#f92672>().</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> executeResultSample <span style=color:#66d9ef>instanceof</span> QueryResult
</span></span><span style=display:flex><span>            <span style=color:#f92672>?</span> processExecuteQuery<span style=color:#f92672>(</span>executionContext<span style=color:#f92672>,</span> result<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>QueryResult<span style=color:#f92672>)</span> executeResultSample<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>:</span> processExecuteUpdate<span style=color:#f92672>(</span>executionContext<span style=color:#f92672>,</span> result<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>我们不是这里的联邦查询，所以真正的执行在 <code>proxySQLExecutor.checkExecutePrerequisites(executionContext);</code></p><p>在 ProxySQLExecutor 里：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>ExecuteResult<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> ExecutionContext executionContext<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String databaseName <span style=color:#f92672>=</span> backendConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>getConnectionSession</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDatabaseName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Collection<span style=color:#f92672>&lt;</span>ShardingSphereRule<span style=color:#f92672>&gt;</span> rules <span style=color:#f92672>=</span> ProxyContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getContextManager</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getMetaDataContexts</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDatabaseMetaData</span><span style=color:#f92672>(</span>databaseName<span style=color:#f92672>).</span><span style=color:#a6e22e>getRuleMetaData</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getRules</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> maxConnectionsSizePerQuery <span style=color:#f92672>=</span> ProxyContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getContextManager</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getMetaDataContexts</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getProps</span><span style=color:#f92672>().&lt;</span>Integer<span style=color:#f92672>&gt;</span>getValue<span style=color:#f92672>(</span>ConfigurationPropertyKey<span style=color:#f92672>.</span><span style=color:#a6e22e>MAX_CONNECTIONS_SIZE_PER_QUERY</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> isReturnGeneratedKeys <span style=color:#f92672>=</span> executionContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getSqlStatementContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getSqlStatement</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>instanceof</span> MySQLInsertStatement<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> execute<span style=color:#f92672>(</span>executionContext<span style=color:#f92672>,</span> rules<span style=color:#f92672>,</span> maxConnectionsSizePerQuery<span style=color:#f92672>,</span> isReturnGeneratedKeys<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>ExecuteResult<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> ExecutionContext executionContext<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Collection<span style=color:#f92672>&lt;</span>ShardingSphereRule<span style=color:#f92672>&gt;</span> rules<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> maxConnectionsSizePerQuery<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isReturnGeneratedKeys<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> hasRawExecutionRule<span style=color:#f92672>(</span>rules<span style=color:#f92672>)</span> <span style=color:#f92672>?</span> rawExecute<span style=color:#f92672>(</span>executionContext<span style=color:#f92672>,</span> rules<span style=color:#f92672>,</span> maxConnectionsSizePerQuery<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>:</span> useDriverToExecute<span style=color:#f92672>(</span>executionContext<span style=color:#f92672>,</span> rules<span style=color:#f92672>,</span> maxConnectionsSizePerQuery<span style=color:#f92672>,</span> isReturnGeneratedKeys<span style=color:#f92672>,</span> SQLExecutorExceptionHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>isExceptionThrown</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里 <code>backendConnection</code>的实现是 <code>JDBCBackendConnection</code>. 采用的是 <code>useDriverToExecute</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>ExecuteResult<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>useDriverToExecute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> ExecutionContext executionContext<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Collection<span style=color:#f92672>&lt;</span>ShardingSphereRule<span style=color:#f92672>&gt;</span> rules<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                               <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> maxConnectionsSizePerQuery<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isReturnGeneratedKeys<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isExceptionThrown<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    JDBCBackendStatement statementManager <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>JDBCBackendStatement<span style=color:#f92672>)</span> backendConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>getConnectionSession</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getStatementManager</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    DriverExecutionPrepareEngine<span style=color:#f92672>&lt;</span>JDBCExecutionUnit<span style=color:#f92672>,</span> Connection<span style=color:#f92672>&gt;</span> prepareEngine <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DriverExecutionPrepareEngine<span style=color:#f92672>&lt;&gt;(</span>
</span></span><span style=display:flex><span>            type<span style=color:#f92672>,</span> maxConnectionsSizePerQuery<span style=color:#f92672>,</span> backendConnection<span style=color:#f92672>,</span> statementManager<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> StatementOption<span style=color:#f92672>(</span>isReturnGeneratedKeys<span style=color:#f92672>),</span> rules<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    ExecutionGroupContext<span style=color:#f92672>&lt;</span>JDBCExecutionUnit<span style=color:#f92672>&gt;</span> executionGroupContext<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        executionGroupContext <span style=color:#f92672>=</span> prepareEngine<span style=color:#f92672>.</span><span style=color:#a6e22e>prepare</span><span style=color:#f92672>(</span>executionContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getRouteContext</span><span style=color:#f92672>(),</span> executionContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getExecutionUnits</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> SQLException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getSaneExecuteResults<span style=color:#f92672>(</span>executionContext<span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    executionGroupContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setDatabaseName</span><span style=color:#f92672>(</span>backendConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>getConnectionSession</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDatabaseName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    executionGroupContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setGrantee</span><span style=color:#f92672>(</span>backendConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>getConnectionSession</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getGrantee</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> jdbcExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>executionContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogicSQL</span><span style=color:#f92672>(),</span> executionGroupContext<span style=color:#f92672>,</span> isReturnGeneratedKeys<span style=color:#f92672>,</span> isExceptionThrown<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>使用的 <code>ProxyJDBCExecutor</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>jdbcExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>executionContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogicSQL</span><span style=color:#f92672>(),</span> executionGroupContext<span style=color:#f92672>,</span> isReturnGeneratedKeys<span style=color:#f92672>,</span> isExceptionThrown<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>这里面又调用了一个 <code>JDBCExecutor</code>来最终执行，这里的关键点是 <code>ProxyJDBCExecutorCallbackFactory.newInstance(type, databaseType, context.getSqlStatement(), databaseCommunicationEngine, isReturnGeneratedKeys, isExceptionThrown, false)</code>会创建一个回调。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>ExecuteResult<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> LogicSQL logicSQL<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> ExecutionGroupContext<span style=color:#f92672>&lt;</span>JDBCExecutionUnit<span style=color:#f92672>&gt;</span> executionGroupContext<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                   <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isReturnGeneratedKeys<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isExceptionThrown<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        MetaDataContexts metaDataContexts <span style=color:#f92672>=</span> ProxyContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getContextManager</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getMetaDataContexts</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        DatabaseType databaseType <span style=color:#f92672>=</span> metaDataContexts<span style=color:#f92672>.</span><span style=color:#a6e22e>getDatabaseMetaData</span><span style=color:#f92672>(</span>connectionSession<span style=color:#f92672>.</span><span style=color:#a6e22e>getDatabaseName</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>getResource</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDatabaseType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        ExecuteProcessEngine<span style=color:#f92672>.</span><span style=color:#a6e22e>initialize</span><span style=color:#f92672>(</span>logicSQL<span style=color:#f92672>,</span> executionGroupContext<span style=color:#f92672>,</span> metaDataContexts<span style=color:#f92672>.</span><span style=color:#a6e22e>getProps</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        SQLStatementContext<span style=color:#f92672>&lt;?&gt;</span> context <span style=color:#f92672>=</span> logicSQL<span style=color:#f92672>.</span><span style=color:#a6e22e>getSqlStatementContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>ExecuteResult<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> jdbcExecutor<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>executionGroupContext<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                ProxyJDBCExecutorCallbackFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> databaseType<span style=color:#f92672>,</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getSqlStatement</span><span style=color:#f92672>(),</span> databaseCommunicationEngine<span style=color:#f92672>,</span> isReturnGeneratedKeys<span style=color:#f92672>,</span> isExceptionThrown<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                ProxyJDBCExecutorCallbackFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>(</span>type<span style=color:#f92672>,</span> databaseType<span style=color:#f92672>,</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getSqlStatement</span><span style=color:#f92672>(),</span> databaseCommunicationEngine<span style=color:#f92672>,</span> isReturnGeneratedKeys<span style=color:#f92672>,</span> isExceptionThrown<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        ExecuteProcessEngine<span style=color:#f92672>.</span><span style=color:#a6e22e>finish</span><span style=color:#f92672>(</span>executionGroupContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getExecutionID</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ExecuteProcessEngine<span style=color:#f92672>.</span><span style=color:#a6e22e>clean</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>真正的执行会到 <code>ProxyStatementExecutorCallback</code>回调里用 JDBC原生Statement去执行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProxyStatementExecutorCallback</span> <span style=color:#66d9ef>extends</span> ProxyJDBCExecutorCallback <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String sql<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Statement statement<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isReturnGeneratedKeys<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> statement<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>sql<span style=color:#f92672>,</span> isReturnGeneratedKeys <span style=color:#f92672>?</span> Statement<span style=color:#f92672>.</span><span style=color:#a6e22e>RETURN_GENERATED_KEYS</span> <span style=color:#f92672>:</span> Statement<span style=color:#f92672>.</span><span style=color:#a6e22e>NO_GENERATED_KEYS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul class=pa0><li class="list di"><a href=/tags/shardingsphere class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">shardingsphere</a></li></ul><div class="mt6 instapaper_ignoref"><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//jimolonely.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">相关內容</p><ul class="pa0 list"><li class=mb2><a href=/tech/database/shardingsphere-build-guide/>ShardingSphere开发者编译指南</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://jimolonely.github.io/>&copy; 孤独的寂寞 2022</a><div><div class=ananke-socials><a href=https://github.com/jimolonely target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>